<%- include("partials/top") %>
<%
  const formatDateDE = (isoStr) => {
    if (!isoStr) return "";
    const [y, m, d] = isoStr.split("-");
    return `${d}.${m}.${y}`;
  };
  const today = new Date().toISOString().slice(0, 10);
%>
<section class="card fade-in">
  <div class="section-head">
    <h1>Einstellungen</h1>
    <p class="subtle">Kassenstand, Ausgaben und Anfangswerte verwalten.</p>
  </div>

  <div class="tab-nav">
    <button type="button" class="tab-btn active" data-tab="kasse">Kasse</button>
    <button type="button" class="tab-btn" data-tab="anfangswerte">Anfangswerte</button>
    <button type="button" class="tab-btn" data-tab="aktivitaet">Aktivit&auml;t</button>
  </div>

  <!-- Tab: Kasse -->
  <div id="tab-kasse" class="tab-panel active">

    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 1.5rem;">
      <div class="stat-card">
        <div class="stat-value"><%= formatEuro(kassenstand) %> &euro;</div>
        <div class="stat-label">Kassenstand</div>
      </div>
    </div>

    <h2>IST-Kassenstand (Startwert)</h2>
    <p class="subtle">Einmalig den tatsächlichen Kassenstand eingeben, ab dem gerechnet wird.</p>
    <form method="post" action="/admin/kassenstand" class="inline-form" style="margin-bottom: 2rem;">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <label>Startwert (&euro;)
        <input type="number" name="kassenstandStart" step="0.01" value="<%= kassenstandStart.toFixed(2) %>" required />
      </label>
      <button type="submit">Startwert speichern</button>
    </form>

    <h2>Ausgabe hinzufügen</h2>
    <form method="post" action="/admin/expenses" class="inline-form" style="margin-bottom: 2rem;">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <label>Betrag (&euro;)
        <input type="number" name="amount" step="0.01" min="0.01" required />
      </label>
      <label>Beschreibung
        <input type="text" name="description" maxlength="200" required placeholder="z. B. Kugeln polieren" />
      </label>
      <label>Datum
        <input type="date" name="expense_date" value="<%= today %>" required />
      </label>
      <button type="submit">Ausgabe speichern</button>
    </form>

    <% if (expenses.length > 0) { %>
      <h2>Ausgaben</h2>
      <div class="records-table-wrap">
        <table class="records-table" id="expensesTable">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Beschreibung</th>
              <th>Betrag</th>
              <th class="actions"></th>
            </tr>
          </thead>
          <tbody>
            <% expenses.forEach((exp) => { %>
              <tr data-expense-id="<%= exp.id %>">
                <td class="expense-date"><%= formatDateDE(exp.expense_date) %></td>
                <td class="expense-desc"><%= exp.description %></td>
                <td class="expense-amount"><%= formatEuro(exp.amount) %> &euro;</td>
                <td class="actions">
                  <div class="action-btns">
                    <button type="button" class="btn-edit btn-sm btn-expense-edit" title="Bearbeiten">&#x270E;</button>
                    <form method="post" action="/admin/expenses/delete" data-confirm="Ausgabe wirklich löschen?">
                      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
                      <input type="hidden" name="expenseId" value="<%= exp.id %>" />
                      <button type="submit" class="btn-danger btn-sm">&times;</button>
                    </form>
                  </div>
                  <form method="post" action="/admin/expenses/edit" class="edit-form" style="display:none">
                    <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
                    <input type="hidden" name="expenseId" value="<%= exp.id %>" />
                    <input type="hidden" name="amount" class="edit-amount-val" />
                    <input type="hidden" name="description" class="edit-desc-val" />
                    <input type="hidden" name="expense_date" class="edit-date-val" />
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="subtle">Noch keine Ausgaben erfasst.</p>
    <% } %>
  </div>

  <!-- Tab: Anfangswerte -->
  <div id="tab-anfangswerte" class="tab-panel">
    <p class="subtle">Anfangswerte, die vor dem ersten erfassten Spieltag gelten. Der Übertrag wird nur für neue Spieltage verwendet, wenn kein vorheriger Spieltag existiert.</p>
    <form method="post" action="/admin/initial-values">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <div class="records-table-wrap">
        <table class="records-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>9er</th>
              <th>Kränze</th>
              <th>Übertrag&nbsp;(&euro;)</th>
              <th>Monte&nbsp;Pkt.</th>
              <th>Monte&nbsp;&#x1F451;</th>
              <th>Med.&nbsp;Pkt.</th>
              <th>Med.&nbsp;&#x1F451;</th>
            </tr>
          </thead>
          <tbody>
            <% members.forEach((m) => {
              const iv = initialMap.get(m.id) || { initial_alle9: 0, initial_kranz: 0, initial_carryover: 0, initial_monte_points: 0, initial_monte_siege: 0, initial_medaillen_points: 0, initial_medaillen_siege: 0 };
            %>
              <tr>
                <td><%= m.display_name %></td>
                <td><input type="number" name="initial_alle9_<%= m.id %>" min="0" value="<%= iv.initial_alle9 %>" class="mini-number" style="width:48px" /></td>
                <td><input type="number" name="initial_kranz_<%= m.id %>" min="0" value="<%= iv.initial_kranz %>" class="mini-number" style="width:48px" /></td>
                <td><input type="number" name="initial_carryover_<%= m.id %>" step="0.01" value="<%= iv.initial_carryover.toFixed(2) %>" class="mini-number no-spin" style="width:64px" /></td>
                <td><input type="number" name="initial_monte_points_<%= m.id %>" min="0" value="<%= iv.initial_monte_points %>" class="mini-number" style="width:48px" /></td>
                <td><input type="number" name="initial_monte_siege_<%= m.id %>" min="0" value="<%= iv.initial_monte_siege %>" class="mini-number" style="width:48px" /></td>
                <td><input type="number" name="initial_medaillen_points_<%= m.id %>" min="0" value="<%= iv.initial_medaillen_points %>" class="mini-number" style="width:48px" /></td>
                <td><input type="number" name="initial_medaillen_siege_<%= m.id %>" min="0" value="<%= iv.initial_medaillen_siege %>" class="mini-number" style="width:48px" /></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <button type="submit" style="margin-top: 1rem;">Anfangswerte speichern</button>
    </form>
  </div>

  <!-- Tab: Aktivität -->
  <div id="tab-aktivitaet" class="tab-panel">
    <%
      const actionLabels = {
        LOGIN: "Anmeldung",
        LOGOUT: "Abmeldung",
        SETUP_COMPLETE: "Ersteinrichtung",
        MEMBER_CREATE: "Mitglied erstellt",
        MEMBER_UPDATE: "Mitglied bearbeitet",
        MEMBER_DELETE: "Mitglied gel\u00f6scht",
        MEMBER_ORDER_UPDATE: "Reihenfolge ge\u00e4ndert",
        GAMEDAY_CREATE: "Spieltag erstellt",
        GAMEDAY_DELETE: "Spieltag gel\u00f6scht",
        GAMEDAY_STATUS_CHANGE: "Status ge\u00e4ndert",
        ATTENDANCE_UPDATE: "Anwesenheit ge\u00e4ndert",
        FIELD_UPDATE: "Feld ge\u00e4ndert",
        EXPENSE_CREATE: "Ausgabe erstellt",
        EXPENSE_EDIT: "Ausgabe bearbeitet",
        EXPENSE_DELETE: "Ausgabe gel\u00f6scht",
        KASSENSTAND_START_SET: "Startwert gesetzt",
        INITIAL_VALUES_UPDATE: "Anfangswerte ge\u00e4ndert",
        RECORD_CREATE: "Rekord erstellt",
        RECORD_DELETE: "Rekord gel\u00f6scht",
        CUSTOM_GAME_CREATE: "Spiel erstellt",
        CUSTOM_GAME_DELETE: "Spiel gel\u00f6scht",
        CUSTOM_GAME_RENAME: "Spiel umbenannt",
        CUSTOM_GAME_VALUE_UPDATE: "Spielwert ge\u00e4ndert",
        PASSWORD_CHANGE: "Passwort ge\u00e4ndert",
        GAMEDAY_ENTRY_CREATE: "Eintrag erstellt",
        GAMEDAY_ENTRY_DELETE: "Eintrag gel\u00f6scht",
        GAMEDAY_ENTRY_UPDATE: "Eintrag ge\u00e4ndert",
        PIN_MESSAGE_CREATE: "Pinnwand-Nachricht erstellt",
        PIN_MESSAGE_DELETE: "Pinnwand-Nachricht gel\u00f6scht",
        PIN_ADD: "Pinnwand-Nachricht erstellt",
        PIN_DELETE: "Pinnwand-Nachricht gel\u00f6scht",
        PIN_UPDATE: "Pinnwand-Nachricht bearbeitet",
        GAMEDAY_STATUS_ADVANCE: "Status vorger\u00fcckt",
        GAMEDAY_STATUS_REVERT: "Status zur\u00fcckgesetzt",
        GAMEDAY_NOTE_UPDATE: "Notiz ge\u00e4ndert",
        LANE_COST_UPDATE: "Bahnkosten ge\u00e4ndert"
      };

      const parseDate = (str) => {
        if (!str) return null;
        return new Date(str.replace(" ", "T") + (str.includes("+") || str.includes("Z") ? "" : "Z"));
      };

      const timeAgo = (isoStr) => {
        const d = parseDate(isoStr);
        if (!d || isNaN(d)) return "Nie";
        const now = new Date();
        const diffMs = now - d;
        const diffMin = Math.floor(diffMs / 60000);
        if (diffMin < 1) return "Gerade eben";
        if (diffMin < 60) return `vor ${diffMin} Min.`;
        const diffH = Math.floor(diffMin / 60);
        if (diffH < 24) return `vor ${diffH} Std.`;
        const diffD = Math.floor(diffH / 24);
        if (diffD === 1) return "Gestern";
        if (diffD < 30) return `vor ${diffD} Tagen`;
        const diffM = Math.floor(diffD / 30);
        if (diffM < 12) return `vor ${diffM} Mon.`;
        return `vor ${Math.floor(diffM / 12)} J.`;
      };

      const formatTimestamp = (isoStr) => {
        const d = parseDate(isoStr);
        if (!d || isNaN(d)) return "";
        const pad = (n) => String(n).padStart(2, "0");
        return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      };
    %>

    <% if (currentUser.id === 1) { %>
    <h2>Letzter Login</h2>
    <div class="records-table-wrap">
      <table class="records-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Benutzername</th>
            <th>Rolle</th>
            <th>Letzter Login</th>
            <th>Erstellt am</th>
          </tr>
        </thead>
        <tbody>
          <% usersLastLogin.forEach((u) => { %>
            <tr>
              <td><%= u.first_name %> <%= u.last_name %></td>
              <td><%= u.username %></td>
              <td><%= u.role === "admin" ? "Admin" : "Benutzer" %></td>
              <td title="<%= u.last_login_at ? formatTimestamp(u.last_login_at) : '' %>"><%= timeAgo(u.last_login_at) %></td>
              <td><%= formatTimestamp(u.created_at) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>

    <h2 style="margin-top: 2rem;">Letzte Aktionen</h2>
    <% if (auditLog.length > 0) { %>
      <div class="records-table-wrap">
        <table class="records-table">
          <thead>
            <tr>
              <th>Zeitpunkt</th>
              <th>Benutzer</th>
              <th>Aktion</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <% auditLog.forEach((entry) => { %>
              <tr>
                <td><%= formatTimestamp(entry.created_at) %></td>
                <td><%= entry.first_name %> <%= entry.last_name %></td>
                <td><%= actionLabels[entry.action] || entry.action %></td>
                <td class="subtle" style="max-width:240px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                  <% if (entry.target_type) { %><%= entry.target_type %><% if (entry.target_id) { %>#<%= entry.target_id %><% } %><% } %>
                  <% if (entry.details) { %>
                    <% try { const d = JSON.parse(entry.details); %>
                      <% if (d.username) { %> &ndash; <%= d.username %><% } %>
                      <% if (d.description) { %> &ndash; <%= d.description %><% } %>
                      <% if (d.field) { %> &ndash; <%= d.field %><% } %>
                    <% } catch(e) { %><%= entry.details %><% } %>
                  <% } %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } else { %>
      <p class="subtle">Noch keine Aktionen aufgezeichnet.</p>
    <% } %>
  </div>

  <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--line);">
    <h2 style="margin-top: 0;">Gag-Animationen</h2>
    <p class="subtle">Kleine Animationen bei Pudel, 9er und Kranz auf der Kladde-Seite.</p>
    <form method="post" action="/admin/toggle-gags" class="inline-form">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <label class="toggle-label">
        <input type="checkbox" <%= gagAnimations === "1" ? "checked" : "" %> onchange="this.form.submit()" />
        <span><%= gagAnimations === "1" ? "Aktiviert" : "Deaktiviert" %></span>
      </label>
    </form>
  </div>

  <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--line);">
    <h2 style="margin-top: 0;">Feuerwerk testen</h2>
    <p class="subtle">Zeigt die Siegesfeier-Animation als Vorschau.</p>
    <button type="button" id="btnTestCelebration">Feuerwerk testen</button>
  </div>
  <script>
    document.getElementById("btnTestCelebration").addEventListener("click", function() {
      if (typeof showCelebration === "function") {
        showCelebration([{ type: "monte", round: 42, winner: "Testsieger", score: 107 }]);
      }
    });
  </script>

</section>
<%- include("partials/bottom") %>
