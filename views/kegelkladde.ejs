<%- include("partials/top") %>
<%
  const formatEuro = (value) => Number(value || 0).toFixed(2).replace(".", ",");
  const renderTally = (count) => {
    const safe = Math.min(count, 99);
    const fives = Math.floor(safe / 5);
    const rest = safe % 5;
    let html = '';
    for (let i = 0; i < fives; i++) {
      html += '<span class="tally-five">||||</span>';
      if ((i + 1) % 4 === 0 && (i + 1 < fives || rest > 0)) html += '<span class="tally-break"></span>';
    }
    if (rest > 0) html += '|'.repeat(rest);
    return html;
  };
%>
<section class="card fade-in">
  <div class="section-head">
    <h1>Kegelkladde</h1>
    <p class="subtle">Spieltage verwalten und Ergebnisse eintragen.</p>
  </div>

  <%
    // Datum-Formatierung DD.MM.YYYY
    const formatDateDE = (isoStr) => {
      const [y, m, d] = isoStr.split("-");
      return `${d}.${m}.${y}`;
    };
  %>

  <nav class="gameday-nav" id="gamedayNav">
    <button type="button" class="btn-secondary btn-sm" id="btnPrev" title="Vorheriger Spieltag">&laquo; Zurück</button>
    <select id="gamedaySelect">
      <% gamedays.forEach((day) => { %>
        <option value="<%= day.id %>" <%= selectedGameday && selectedGameday.id === day.id && !isNext ? "selected" : "" %>>
          <%= formatDateDE(day.match_date) %><%= day.note ? ` - ${day.note}` : "" %><%= day.settled ? " (abger.)" : "" %>
        </option>
      <% }) %>
      <option value="next" <%= isNext || (!selectedGameday && !hasGamedays) ? "selected" : "" %>>
        Nächster Spieltag (<%= formatDateDE(nextDate) %>)
      </option>
    </select>
    <button type="button" class="btn-secondary btn-sm" id="btnNext" title="Nächster Spieltag">Weiter &raquo;</button>
  </nav>

  <% if (isNext || (!selectedGameday && !hasGamedays)) { %>
    <!-- Nächster Spieltag: Vorschau + Starten -->
    <% if (isAdmin) { %>
      <div class="start-gameday-bar">
        <form method="post" action="/kegelkladde/gamedays" class="start-gameday-form" id="startGamedayForm">
          <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
          <label>Datum
            <input type="date" name="matchDate" value="<%= nextDate %>" required />
          </label>
          <label>Notiz (optional)
            <input name="note" maxlength="120" placeholder="z. B. Faschingsrunde" />
          </label>
          <button type="submit">Spieltag starten</button>
        </form>
      </div>
    <% } %>

    <!-- Leere Kladde-Vorschau -->
    <div class="table-shell desktop-only">
      <table class="kladde-table kladde-preview">
        <colgroup>
          <col style="width: 110px;" />
          <col style="width: 44px;" />
          <col style="width: 70px;" />
          <col style="width: 52px;" />
          <col style="width: 120px;" />
          <col style="width: 120px;" />
          <col style="width: 120px;" />
          <col style="width: 120px;" />
          <col style="width: 52px;" />
          <col style="width: 52px;" />
          <col style="width: 52px;" />
          <col style="width: 52px;" />
          <col style="width: 70px;" />
          <col style="width: 70px;" />
        </colgroup>
        <thead>
          <tr>
            <th><span class="head-label">Name</span></th>
            <th><span class="head-label">Anwesend</span></th>
            <th><span class="head-label">Beitrag</span></th>
            <th><span class="head-label">Strafen</span></th>
            <th><span class="head-label">9er</span></th>
            <th><span class="head-label">Kranz</span></th>
            <th><span class="head-label">Triclops</span></th>
            <th><span class="head-label">Pudel</span></th>
            <th class="game-col"><span class="head-label">V+A</span></th>
            <th class="game-col"><span class="head-label">Monte</span></th>
            <th class="game-col"><span class="head-label">Aussteigen</span></th>
            <th class="game-col"><span class="head-label">6-Tage</span></th>
            <th><span class="head-label">Übertrag</span></th>
            <th><span class="head-label">Zu zahlen</span></th>
          </tr>
        </thead>
        <tbody>
          <% members.forEach((member) => { %>
            <tr>
              <td class="name-col"><%= member.display_name %></td>
              <td>
                <label class="present-toggle">
                  <input type="checkbox" checked disabled />
                  <img src="/sheep.png" alt="Anwesend" class="present-icon" />
                </label>
              </td>
              <td><span class="money-text"><%= formatEuro(4) %> &euro;</span></td>
              <td><span class="money-text">0,00 &euro;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td><span class="money-text">0,00 &euro;</span></td>
              <td><span class="money-text">4,00 &euro;</span></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <div class="mobile-only">
      <p class="subtle" style="text-align: center; padding: 2rem 0;">
        <% if (isAdmin) { %>Spieltag starten, um die Kladde zu bearbeiten.<% } else { %>Noch kein Spieltag gestartet.<% } %>
      </p>
    </div>

  <% } else if (selectedGameday) { %>

    <div class="settle-row">
      <p>
        Status:
        <% if (selectedGameday.settled) { %>
          <span class="badge badge-success">Abgerechnet</span>
        <% } else { %>
          <span class="badge badge-warning">Offen</span>
        <% } %>
      </p>
      <% if (isAdmin) { %>
        <div class="settle-actions">
          <% if (selectedGameday.settled) { %>
            <form method="post" action="/kegelkladde/unsettle">
              <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
              <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
              <button type="submit" class="btn-secondary btn-sm">Wieder öffnen</button>
            </form>
          <% } %>
          <form method="post" action="/kegelkladde/delete" data-confirm="Spieltag wirklich löschen? Alle Daten gehen verloren!">
            <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
            <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
            <button type="submit" class="btn-danger btn-sm">Löschen</button>
          </form>
        </div>
      <% } %>
    </div>

    <%
      let totalAlle9Present = 0, totalKranzPresent = 0, totalTriclopsPresent = 0;
      members.forEach((m) => {
        const h = attendanceMap.get(m.id) || { present: 0, alle9: 0, kranz: 0, triclops: 0 };
        if (h.present) {
          totalAlle9Present += Number(h.alle9 || 0);
          totalKranzPresent += Number(h.kranz || 0);
          totalTriclopsPresent += Number(h.triclops || 0);
        }
      });
    %>

    <!-- Desktop table view -->
    <div class="table-shell desktop-only" id="kladdeData" data-csrf="<%= csrfToken %>" data-gameday-id="<%= selectedGameday.id %>" data-settled="<%= selectedGameday.settled ? '1' : '0' %>">
        <table class="kladde-table">
          <colgroup>
            <col style="width: 110px;" /><!-- Name -->
            <col style="width: 44px;" /><!-- Anwesenheit -->
            <col style="width: 70px;" /><!-- Beitrag -->
            <col style="width: 52px;" /><!-- Strafen -->
            <col style="width: 120px;" /><!-- 9er -->
            <col style="width: 120px;" /><!-- Kranz -->
            <col style="width: 120px;" /><!-- Triclops -->
            <col style="width: 120px;" /><!-- Pudel -->
            <col style="width: 52px;" /><!-- V+A -->
            <col style="width: 52px;" /><!-- Monte -->
            <col style="width: 52px;" /><!-- Aussteigen -->
            <col style="width: 52px;" /><!-- 6-Tage -->
            <% customGames.forEach(() => { %>
            <col style="width: 52px;" />
            <% }) %>
            <% if (isAdmin && !selectedGameday.settled) { %>
            <col style="width: 52px;" /><!-- Neue Spalte -->
            <% } %>
            <col style="width: 70px;" /><!-- Übertrag -->
            <col style="width: 70px;" /><!-- Zu zahlen -->
            <% if (selectedGameday.settled) { %>
            <col style="width: 70px;" /><!-- Gezahlt -->
            <col style="width: 70px;" /><!-- Rest -->
            <% } %>
          </colgroup>
          <thead>
            <tr>
              <th><span class="head-label">Name</span></th>
              <th><span class="head-label">Anwesend</span></th>
              <th><span class="head-label">Beitrag</span></th>
              <th><span class="head-label">Strafen</span></th>
              <th title="Alle 9"><span class="head-label">9er</span></th>
              <th title="Kranz"><span class="head-label">Kranz</span></th>
              <th><span class="head-label">Triclops</span></th>
              <th><span class="head-label">Pudel</span></th>
              <th class="game-col"><span class="head-label">V+A</span></th>
              <th class="game-col"><span class="head-label">Monte</span></th>
              <th class="game-col"><span class="head-label">Aussteigen</span></th>
              <th class="game-col"><span class="head-label">6-Tage</span></th>
              <% customGames.forEach((cg) => { %>
              <th class="game-col"><span class="head-label"><%= cg.name %></span></th>
              <% }) %>
              <% if (isAdmin && !selectedGameday.settled) { %>
              <th class="game-col"><input type="text" class="custom-game-header-input" placeholder="Spiel..." data-new-game-header /></th>
              <% } %>
              <th><span class="head-label">Übertrag</span></th>
              <th><span class="head-label">Zu zahlen</span></th>
              <% if (selectedGameday.settled) { %>
              <th><span class="head-label">Gezahlt</span></th>
              <th><span class="head-label">Rest</span></th>
              <% } %>
            </tr>
          </thead>
          <tbody>
            <% members.forEach((member, i) => {
              const hit = attendanceMap.get(member.id) || { present: 0, penalties: 0, contribution: 0, pudel: 0, alle9: 0, kranz: 0, triclops: 0, carryover: 0, paid: 0 };
              const pudel = Number(hit.pudel || 0);
              const alle9 = Number(hit.alle9 || 0);
              const kranz = Number(hit.kranz || 0);
              const triclops = Number(hit.triclops || 0);
              const isEditable = isAdmin && !selectedGameday.settled;
              const canEdit = isEditable && hit.present;
            %>
              <tr data-member-id="<%= member.id %>" class="<%= hit.present ? '' : 'row-inactive' %>">
                <td class="name-col"><%= member.display_name %></td>
                <td>
                  <label class="present-toggle" title="Anwesend">
                    <input type="checkbox" name="present_<%= member.id %>" <%= hit.present ? "checked" : "" %> <%= isEditable ? "" : "disabled" %> data-present />
                    <img src="/sheep.png" alt="Anwesend" class="present-icon" />
                  </label>
                </td>
                <td>
                  <span class="money-text"><%= formatEuro(hit.contribution || 0) %> €</span>
                </td>
                <td><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= Number(hit.penalties || 0).toFixed(2) %>" name="penalties_<%= member.id %>" class="mini-number no-spin" <%= canEdit ? "" : "disabled" %> data-field />&euro;</span></td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="alle9_<%= member.id %>" value="<%= alle9 %>" data-marker-input="alle9" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="alle9" data-op="dec" aria-label="Alle 9 verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="alle9"><%- renderTally(alle9) %></span>
                    <button type="button" class="mark-btn" data-mark-target="alle9" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costAlle9 = hit.present ? (totalAlle9Present - alle9) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="alle9"><%= costAlle9 > 0 ? formatEuro(costAlle9) + ' €' : '' %></span>
                </td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="kranz_<%= member.id %>" value="<%= kranz %>" data-marker-input="kranz" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="kranz" data-op="dec" aria-label="Kranz verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="kranz"><%- renderTally(kranz) %></span>
                    <button type="button" class="mark-btn" data-mark-target="kranz" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costKranz = hit.present ? (totalKranzPresent - kranz) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="kranz"><%= costKranz > 0 ? formatEuro(costKranz) + ' €' : '' %></span>
                </td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="triclops_<%= member.id %>" value="<%= triclops %>" data-marker-input="triclops" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="triclops" data-op="dec" aria-label="Triclops verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="triclops"><%- renderTally(triclops) %></span>
                    <button type="button" class="mark-btn" data-mark-target="triclops" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costTriclops = hit.present ? (totalTriclopsPresent - triclops) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="triclops"><%= costTriclops > 0 ? formatEuro(costTriclops) + ' €' : '' %></span>
                </td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="pudel_<%= member.id %>" value="<%= pudel %>" data-marker-input="pudel" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="pudel" data-op="dec" aria-label="Pudel verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="pudel"><%- renderTally(pudel) %></span>
                    <button type="button" class="mark-btn" data-mark-target="pudel" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costPudel = hit.present ? pudel * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="pudel"><%= costPudel > 0 ? formatEuro(costPudel) + ' €' : '' %></span>
                </td>
                <%
                  const vaVal = Number(hit.va || 0);
                  const monteVal = Number(hit.monte || 0);
                  const aussteigenVal = Number(hit.aussteigen || 0);
                  const sechsTageVal = Number(hit.sechs_tage || 0);
                %>
                <td class="game-col"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= vaVal.toFixed(2) %>" name="va_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;</span></td>
                <td class="game-col"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= monteVal.toFixed(2) %>" name="monte_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;</span></td>
                <td class="game-col"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= aussteigenVal.toFixed(2) %>" name="aussteigen_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;</span></td>
                <td class="game-col"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= sechsTageVal.toFixed(2) %>" name="sechs_tage_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;</span></td>
                <% customGames.forEach((cg) => {
                  const cgVal = Number(customGameValues.get(member.id + '_' + cg.id) || 0);
                %>
                <td class="game-col"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= cgVal.toFixed(2) %>" data-custom-game-id="<%= cg.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-custom-game-field />&euro;</span></td>
                <% }) %>
                <% if (isAdmin && !selectedGameday.settled) { %>
                <td class="game-col"></td>
                <% } %>
                <%
                  const carryover = Number(hit.carryover || 0);
                  const paid = Number(hit.paid || 0);
                  const pudelCostCalc = hit.present ? pudel * 0.10 : 0;
                  const alle9CostCalc = hit.present ? (totalAlle9Present - alle9) * 0.10 : 0;
                  const kranzCostCalc = hit.present ? (totalKranzPresent - kranz) * 0.10 : 0;
                  const triclopsCostCalc = hit.present ? (totalTriclopsPresent - triclops) * 0.10 : 0;
                  const gameCosts = hit.present ? vaVal + monteVal + aussteigenVal + sechsTageVal : 0;
                  let customGameTotal = 0;
                  if (hit.present) {
                    customGames.forEach((cg) => {
                      customGameTotal += Number(customGameValues.get(member.id + '_' + cg.id) || 0);
                    });
                  }
                  const toPay = hit.present ? (hit.contribution || 0) + (hit.penalties || 0) + pudelCostCalc + alle9CostCalc + kranzCostCalc + triclopsCostCalc + gameCosts + customGameTotal + carryover : carryover;
                  const rest = toPay - paid;
                %>
                <td>
                  <span class="money-text" data-carryover data-value="<%= carryover %>"><%= formatEuro(carryover) %> &euro;</span>
                </td>
                <td>
                  <span class="money-text" data-topay><%= formatEuro(toPay) %> &euro;</span>
                </td>
                <% if (selectedGameday.settled) { %>
                <td>
                  <span class="money-text" data-paid data-value="<%= paid %>"><%= formatEuro(paid) %> &euro;</span>
                </td>
                <td>
                  <span class="money-text" data-rest><%= formatEuro(rest) %> &euro;</span>
                </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <% if (isAdmin && !selectedGameday.settled) { %>
          <div style="margin-top: 1rem;">
            <form method="post" action="/kegelkladde/settle" data-confirm="Spieltag wirklich abschließen?">
              <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
              <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
              <button type="submit">Spieltag abschließen</button>
            </form>
          </div>
        <% } %>
    </div>

    <!-- Mobile card view -->
    <div class="mobile-only gameday-cards">
      <% if (selectedGameday) { %>
        <article class="gameday-card">
          <h3><%= formatDateDE(selectedGameday.match_date) %></h3>
          <% if (selectedGameday.note) { %><p><%= selectedGameday.note %></p><% } %>
          <ul>
            <% members.forEach((member) => {
              const hit = attendanceMap.get(member.id) || { present: 0, penalties: 0, contribution: 0, pudel: 0, alle9: 0, kranz: 0, triclops: 0, carryover: 0, paid: 0 };
            %>
              <li>
                <span><%= member.display_name %> <% if (hit.present) { %><img src="/sheep.png" alt="Anwesend" class="present-icon-sm" /><% } %></span>
                <span>
                  <%= formatEuro(hit.contribution || 0) %>&euro;
                  <% if (hit.penalties) { %> | S:<%= hit.penalties %><% } %>
                  <% if (hit.pudel) { %> | P:<%= hit.pudel %><% } %>
                  <% if (hit.alle9) { %> | 9:<%= hit.alle9 %><% } %>
                  <% if (hit.kranz) { %> | K:<%= hit.kranz %><% } %>
                  <% if (hit.triclops) { %> | T:<%= hit.triclops %><% } %>
                </span>
              </li>
            <% }) %>
          </ul>
        </article>
        <% if (isAdmin && !selectedGameday.settled) { %>
          <p class="subtle" style="text-align: center; margin-top: 1rem;">
            Für Bearbeitung bitte Desktop-Ansicht verwenden oder Bildschirm drehen.
          </p>
        <% } %>
      <% } %>
    </div>
  <% } %>
</section>

<%- include("partials/bottom") %>
