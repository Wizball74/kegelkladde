<%- include("partials/top") %>
<%
  const formatEuro = (value) => Number(value || 0).toFixed(2).replace(".", ",");
  const renderTally = (count) => {
    const safe = Math.min(count, 99);
    const fives = Math.floor(safe / 5);
    const rest = safe % 5;
    let html = '';
    for (let i = 0; i < fives; i++) {
      html += '<span class="tally-five">||||</span>';
      if ((i + 1) % 4 === 0 && (i + 1 < fives || rest > 0)) html += '<span class="tally-break"></span>';
    }
    if (rest > 0) html += '|'.repeat(rest);
    return html;
  };
%>
<section class="card fade-in">
  <div class="section-head">
    <h1>Kegelkladde</h1>
    <p class="subtle">Spieltage verwalten und Ergebnisse eintragen.</p>
  </div>

  <% if (isAdmin) { %>
    <form method="post" action="/kegelkladde/gamedays" class="inline-form">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <label>Neuer Spieltag
        <input type="date" name="matchDate" required />
      </label>
      <label>Notiz (optional)
        <input name="note" maxlength="120" placeholder="z. B. Faschingsrunde" />
      </label>
      <button type="submit">Spieltag anlegen</button>
    </form>
  <% } %>

  <% if (hasGamedays) { %>
    <form method="get" action="/kegelkladde" class="inline-form">
      <label>Spieltag auswÃ¤hlen
        <select name="gamedayId" onchange="this.form.submit()">
          <% gamedays.forEach((day) => { %>
            <option value="<%= day.id %>" <%= selectedGameday && selectedGameday.id === day.id ? "selected" : "" %>>
              <%= day.match_date %><%= day.note ? ` - ${day.note}` : "" %><%= day.settled ? " (abgerechnet)" : "" %>
            </option>
          <% }) %>
        </select>
      </label>
    </form>

    <div class="settle-row">
      <p>
        Status:
        <% if (selectedGameday.settled) { %>
          <span class="badge badge-success">Abgerechnet</span>
        <% } else { %>
          <span class="badge badge-warning">Offen</span>
        <% } %>
      </p>
      <% if (isAdmin) { %>
        <div class="settle-actions">
          <% if (selectedGameday.settled) { %>
            <form method="post" action="/kegelkladde/unsettle">
              <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
              <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
              <button type="submit" class="btn-secondary btn-sm">Wieder Ã¶ffnen</button>
            </form>
          <% } else { %>
            <form method="post" action="/kegelkladde/settle" data-confirm="Spieltag wirklich abrechnen und sperren?">
              <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
              <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
              <button type="submit" class="btn-sm">Abrechnen</button>
            </form>
          <% } %>
          <form method="post" action="/kegelkladde/delete" data-confirm="Spieltag wirklich lÃ¶schen? Alle Daten gehen verloren!">
            <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
            <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
            <button type="submit" class="btn-danger btn-sm">LÃ¶schen</button>
          </form>
        </div>
      <% } %>
    </div>

    <%
      let totalAlle9Present = 0, totalKranzPresent = 0, totalTriclopsPresent = 0;
      members.forEach((m) => {
        const h = attendanceMap.get(m.id) || { present: 0, alle9: 0, kranz: 0, triclops: 0 };
        if (h.present) {
          totalAlle9Present += Number(h.alle9 || 0);
          totalKranzPresent += Number(h.kranz || 0);
          totalTriclopsPresent += Number(h.triclops || 0);
        }
      });
    %>

    <!-- Desktop table view -->
    <div class="table-shell desktop-only">
      <form method="post" action="/kegelkladde/attendance">
        <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
        <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
        <table class="kladde-table">
          <colgroup>
            <col style="width: 110px;" /><!-- Name -->
            <col style="width: 44px;" /><!-- Anwesenheit -->
            <col style="width: 70px;" /><!-- Beitrag -->
            <col style="width: 52px;" /><!-- Strafen -->
            <col style="width: 120px;" /><!-- Pudel -->
            <col style="width: 120px;" /><!-- 9er -->
            <col style="width: 120px;" /><!-- Kranz -->
            <col style="width: 120px;" /><!-- Triclops -->
            <col style="width: 70px;" /><!-- Ãœbertrag -->
            <col style="width: 70px;" /><!-- Zu zahlen -->
            <col style="width: 70px;" /><!-- Gezahlt -->
            <col style="width: 70px;" /><!-- Rest -->
          </colgroup>
          <thead>
            <tr>
              <th><span class="head-label">Name</span></th>
              <th><span class="head-label">AnwesenheitfÃ¼r </span></th>
              <th><span class="head-label">Beitrag</span></th>
              <th><span class="head-label">Strafen</span></th>
              <th><span class="head-label">Pudel</span></th>
              <th title="Alle 9"><span class="head-label">9er</span></th>
              <th title="Kranz"><span class="head-label">Kranz</span></th>
              <th><span class="head-label">Triclops</span></th>
              <th><span class="head-label">Ãœbertrag</span></th>
              <th><span class="head-label">Zu zahlen</span></th>
              <th><span class="head-label">Gezahlt</span></th>
              <th><span class="head-label">Rest</span></th>
            </tr>
          </thead>
          <tbody>
            <% members.forEach((member, i) => {
              const hit = attendanceMap.get(member.id) || { present: 0, penalties: 0, contribution: 0, pudel: 0, alle9: 0, kranz: 0, triclops: 0, carryover: 0, paid: 0 };
              const pudel = Number(hit.pudel || 0);
              const alle9 = Number(hit.alle9 || 0);
              const kranz = Number(hit.kranz || 0);
              const triclops = Number(hit.triclops || 0);
              const isEditable = isAdmin && !selectedGameday.settled;
              const canEdit = isEditable && hit.present;
            %>
              <tr data-member-id="<%= member.id %>" class="<%= hit.present ? '' : 'row-inactive' %>">
                <td class="name-col"><%= member.display_name %></td>
                <td>
                  <label class="present-toggle" title="Anwesend">
                    <input type="checkbox" name="present_<%= member.id %>" <%= hit.present ? "checked" : "" %> <%= isEditable ? "" : "disabled" %> data-present />
                    <img src="/sheep.png" alt="Anwesend" class="present-icon" />
                  </label>
                </td>
                <td>
                  <span class="money-text"><%= formatEuro(hit.contribution || 0) %> â‚¬</span>
                </td>
                <td><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= Number(hit.penalties || 0).toFixed(2) %>" name="penalties_<%= member.id %>" class="mini-number no-spin" <%= canEdit ? "" : "disabled" %> data-field />&euro;</span></td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="pudel_<%= member.id %>" value="<%= pudel %>" data-marker-input="pudel" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="pudel" data-op="dec" aria-label="Pudel verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="pudel"><%- renderTally(pudel) %></span>
                    <button type="button" class="mark-btn" data-mark-target="pudel" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costPudel = hit.present ? pudel * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="pudel"><%= costPudel > 0 ? formatEuro(costPudel) + ' â‚¬' : '' %></span>
                </td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="alle9_<%= member.id %>" value="<%= alle9 %>" data-marker-input="alle9" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="alle9" data-op="dec" aria-label="Alle 9 verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="alle9"><%- renderTally(alle9) %></span>
                    <button type="button" class="mark-btn" data-mark-target="alle9" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costAlle9 = hit.present ? (totalAlle9Present - alle9) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="alle9"><%= costAlle9 > 0 ? formatEuro(costAlle9) + ' â‚¬' : '' %></span>
                </td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="kranz_<%= member.id %>" value="<%= kranz %>" data-marker-input="kranz" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="kranz" data-op="dec" aria-label="Kranz verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="kranz"><%- renderTally(kranz) %></span>
                    <button type="button" class="mark-btn" data-mark-target="kranz" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costKranz = hit.present ? (totalKranzPresent - kranz) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="kranz"><%= costKranz > 0 ? formatEuro(costKranz) + ' â‚¬' : '' %></span>
                </td>
                <td>
                  <div class="marker-controls">
                    <input type="hidden" name="triclops_<%= member.id %>" value="<%= triclops %>" data-marker-input="triclops" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="triclops" data-op="dec" aria-label="Triclops verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="triclops"><%- renderTally(triclops) %></span>
                    <button type="button" class="mark-btn" data-mark-target="triclops" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costTriclops = hit.present ? (totalTriclopsPresent - triclops) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="triclops"><%= costTriclops > 0 ? formatEuro(costTriclops) + ' â‚¬' : '' %></span>
                </td>
                <%
                  const carryover = Number(hit.carryover || 0);
                  const paid = Number(hit.paid || 0);
                  const pudelCostCalc = hit.present ? pudel * 0.10 : 0;
                  const alle9CostCalc = hit.present ? (totalAlle9Present - alle9) * 0.10 : 0;
                  const kranzCostCalc = hit.present ? (totalKranzPresent - kranz) * 0.10 : 0;
                  const triclopsCostCalc = hit.present ? (totalTriclopsPresent - triclops) * 0.10 : 0;
                  const toPay = hit.present ? (hit.contribution || 0) + (hit.penalties || 0) + pudelCostCalc + alle9CostCalc + kranzCostCalc + triclopsCostCalc + carryover : carryover;
                  const rest = toPay - paid;
                %>
                <td>
                  <span class="money-inline"><input type="number" max="999" step="0.10" value="<%= carryover.toFixed(2) %>" name="carryover_<%= member.id %>" class="mini-number no-spin" <%= canEdit ? "" : "disabled" %> data-field data-carryover />&euro;</span>
                </td>
                <td>
                  <span class="money-text" data-topay><%= formatEuro(toPay) %> &euro;</span>
                </td>
                <td>
                  <span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= paid.toFixed(2) %>" name="paid_<%= member.id %>" class="mini-number no-spin" <%= canEdit ? "" : "disabled" %> data-field data-paid />&euro;</span>
                </td>
                <td>
                  <span class="money-text" data-rest><%= formatEuro(rest) %> &euro;</span>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <% if (isAdmin && !selectedGameday.settled) { %>
          <div style="margin-top: 1rem;">
            <button type="submit">Kladde speichern</button>
          </div>
        <% } %>
      </form>
    </div>

    <!-- Mobile card view -->
    <div class="mobile-only gameday-cards">
      <% if (selectedGameday) { %>
        <article class="gameday-card">
          <h3><%= selectedGameday.match_date %></h3>
          <% if (selectedGameday.note) { %><p><%= selectedGameday.note %></p><% } %>
          <ul>
            <% members.forEach((member) => {
              const hit = attendanceMap.get(member.id) || { present: 0, penalties: 0, contribution: 0, pudel: 0, alle9: 0, kranz: 0, triclops: 0, carryover: 0, paid: 0 };
            %>
              <li>
                <span><%= member.display_name %> <% if (hit.present) { %><img src="/sheep.png" alt="Anwesend" class="present-icon-sm" /><% } %></span>
                <span>
                  <%= formatEuro(hit.contribution || 0) %>â‚¬
                  <% if (hit.penalties) { %> | S:<%= hit.penalties %><% } %>
                  <% if (hit.pudel) { %> | P:<%= hit.pudel %><% } %>
                  <% if (hit.alle9) { %> | 9:<%= hit.alle9 %><% } %>
                  <% if (hit.kranz) { %> | K:<%= hit.kranz %><% } %>
                  <% if (hit.triclops) { %> | T:<%= hit.triclops %><% } %>
                </span>
              </li>
            <% }) %>
          </ul>
        </article>
        <% if (isAdmin && !selectedGameday.settled) { %>
          <p class="subtle" style="text-align: center; margin-top: 1rem;">
            FÃ¼r Bearbeitung bitte Desktop-Ansicht verwenden oder Bildschirm drehen.
          </p>
        <% } %>
      <% } %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ“‹</div>
      <p>Noch kein Spieltag vorhanden.</p>
      <% if (isAdmin) { %>
        <p>Lege oben einen neuen Spieltag an.</p>
      <% } %>
    </div>
  <% } %>
</section>

<% if (isAdmin && hasGamedays) { %>
  <section class="card fade-in" style="margin-top: 1rem;">
    <h2>Mitglieder-Reihenfolge</h2>
    <p class="subtle">Ã„ndere die Spalten-Reihenfolge in der Tabelle.</p>

    <div class="order-box">
      <form method="post" action="/kegelkladde/member-order" id="orderForm">
        <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
        <input type="hidden" name="memberOrder" id="memberOrder" value="" />
        <ul class="order-list" id="orderList">
          <% members.forEach((member) => { %>
            <li data-id="<%= member.id %>">
              <span><%= member.display_name %></span>
              <span>
                <button type="button" class="move-up btn-sm btn-secondary">â†‘</button>
                <button type="button" class="move-down btn-sm btn-secondary">â†“</button>
              </span>
            </li>
          <% }) %>
        </ul>
        <button type="submit">Reihenfolge speichern</button>
      </form>
    </div>
  </section>
<% } %>

<%- include("partials/bottom") %>
