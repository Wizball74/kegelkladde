<%- include("partials/top") %>
<%
  const formatEuro = (value) => Number(value || 0).toFixed(2).replace(".", ",");
  const renderTally = (count) => {
    const safe = Math.min(count, 99);
    const fives = Math.floor(safe / 5);
    const rest = safe % 5;
    let html = '';
    for (let i = 0; i < fives; i++) {
      html += '<span class="tally-five">||||</span>';
      if ((i + 1) % 2 === 0 && (i + 1 < fives || rest > 0)) html += '<span class="tally-break"></span>';
    }
    if (rest > 0) html += '|'.repeat(rest);
    return html;
  };
%>
<section class="card fade-in">
  <%
    // Datum-Formatierung DD.MM.YYYY
    const formatDateDE = (isoStr) => {
      const [y, m, d] = isoStr.split("-");
      return `${d}.${m}.${y}`;
    };
  %>

  <nav class="gameday-nav" id="gamedayNav">
    <button type="button" class="btn-secondary btn-sm" id="btnPrev" title="Vorheriger Spieltag">&laquo; Zurück</button>
    <select id="gamedaySelect">
      <%
        const statusShort = ['', '', '⏳', '✓'];
      %>
      <% gamedays.forEach((day) => { %>
        <option value="<%= day.id %>" <%= selectedGameday && selectedGameday.id === day.id && !isNext ? "selected" : "" %>>
          <%= formatDateDE(day.match_date) %><%= day.note ? ` - ${day.note}` : "" %><%= statusShort[day.settled] ? ` ${statusShort[day.settled]}` : "" %>
        </option>
      <% }) %>
      <option value="next" <%= isNext || (!selectedGameday && !hasGamedays) ? "selected" : "" %>>
        Nächster Spieltag (<%= formatDateDE(nextDate) %>)
      </option>
    </select>
    <button type="button" class="btn-secondary btn-sm" id="btnNext" title="Nächster Spieltag">Weiter &raquo;</button>
  </nav>

  <% if (isNext || (!selectedGameday && !hasGamedays)) { %>
    <!-- Nächster Spieltag: Vorschau + Starten -->
    <div class="start-gameday-bar">
      <form method="post" action="/kegelkladde/gamedays" class="start-gameday-form" id="startGamedayForm">
        <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
        <label>Datum
          <input type="date" name="matchDate" value="<%= nextDate %>" required />
        </label>
        <label>Notiz (optional)
          <input name="note" maxlength="120" placeholder="z. B. Faschingsrunde" />
        </label>
        <button type="submit">Spieltag starten</button>
      </form>
    </div>

    <!-- Leere Kladde-Vorschau -->
    <div class="table-shell desktop-only">
      <table class="kladde-table kladde-preview">
        <colgroup>
          <col style="width: 110px;" />
          <col style="width: 44px;" />
          <col style="width: 70px;" /><!-- Übertrag -->
          <col style="width: 70px;" /><!-- Beitrag -->
          <col style="width: 52px;" />
          <col style="width: 80px;" />
          <col style="width: 80px;" />
          <col style="width: 80px;" />
          <col style="width: 80px;" />
          <col style="width: 52px;" />
          <col style="width: 52px;" />
          <col style="width: 52px;" />
          <col style="width: 52px;" />
          <col style="width: 70px;" />
        </colgroup>
        <thead>
          <tr>
            <th><span class="head-label">Name</span></th>
            <th><span class="head-label">Anwesend</span></th>
            <th><span class="head-label">Übertrag</span></th>
            <th><span class="head-label">Beitrag</span></th>
            <th><span class="head-label">Strafen</span></th>
            <th><span class="head-label">9er</span></th>
            <th><span class="head-label">Kranz</span></th>
            <th><span class="head-label">Triclops</span></th>
            <th><span class="head-label">Pudel</span></th>
            <th class="game-col"><span class="head-label">V+A</span></th>
            <th class="game-col"><span class="head-label">Monte</span></th>
            <th class="game-col"><span class="head-label">Aussteigen</span></th>
            <th class="game-col"><span class="head-label">6-Tage</span></th>
            <th><span class="head-label">Zu zahlen</span></th>
          </tr>
        </thead>
        <tbody>
          <% members.forEach((member) => { %>
            <tr>
              <td class="name-col"><%= member.display_name %></td>
              <td>
                <label class="present-toggle">
                  <input type="checkbox" checked disabled />
                  <img src="/sheep.png" alt="Anwesend" class="present-icon" />
                </label>
              </td>
              <td><span class="money-text">0,00 &euro;</span></td>
              <td><span class="money-text"><%= formatEuro(4) %> &euro;</span></td>
              <td><span class="money-text">0,00 &euro;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td><span class="money-text preview-dash">&mdash;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td class="game-col"><span class="money-text">0,00 &euro;</span></td>
              <td><span class="money-text">4,00 &euro;</span></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <div class="mobile-only">
      <p class="subtle" style="text-align: center; padding: 2rem 0;">
Spieltag starten, um die Kladde zu bearbeiten.
      </p>
    </div>

  <% } else if (selectedGameday) { %>

    <%
      const status = selectedGameday.settled;
      const statusLabels = ['Noch nicht begonnen', 'Spieltag läuft - gut Holz!', 'Abrechnung', 'Archiv'];
      const statusBadges = ['badge-muted', 'badge-warning', 'badge-info', 'badge-success'];
      const advanceLabels = [null, 'Abrechnen!', 'Abrechnung beenden'];
    %>

    <%
      let totalAlle9Present = 0, totalKranzPresent = 0, totalTriclopsPresent = 0;
      members.forEach((m) => {
        const h = attendanceMap.get(m.id) || { present: 0, alle9: 0, kranz: 0, triclops: 0 };
        if (h.present) {
          totalAlle9Present += Number(h.alle9 || 0);
          totalKranzPresent += Number(h.kranz || 0);
          totalTriclopsPresent += Number(h.triclops || 0);
        }
      });
    %>

    <div id="kladdeData" data-csrf="<%= csrfToken %>" data-gameday-id="<%= selectedGameday.id %>" data-status="<%= status %>" data-user-id="<%= currentUser.id %>" data-user-first-name="<%= currentUser.firstName %>">
    <div class="table-shell">
        <table class="kladde-table">
          <colgroup>
            <col style="width: 110px;" /><!-- Name -->
            <col style="width: 44px;" /><!-- Anwesenheit -->
            <col style="width: 70px;" /><!-- Übertrag -->
            <col style="width: 70px;" /><!-- Beitrag -->
            <col style="width: 60px;" /><!-- Strafen -->
            <col style="width: 80px;" /><!-- 9er -->
            <col style="width: 80px;" /><!-- Kranz -->
            <col style="width: 80px;" /><!-- Triclops -->
            <col style="width: 80px;" /><!-- Pudel -->
            <col style="width: 60px;" /><!-- V+A -->
            <col style="width: 72px;" /><!-- Monte (+ Radio) -->
            <col style="width: 60px;" /><!-- Aussteigen -->
            <col style="width: 60px;" /><!-- 6-Tage -->
            <% customGames.forEach(() => { %>
            <col style="width: 60px;" />
            <% }) %>
            <% if (status <= 1) { %>
            <col style="width: 60px;" /><!-- Neue Spalte -->
            <% } %>
            <col style="width: 70px;" /><!-- Zu zahlen -->
            <% if (status >= 2) { %>
            <col style="width: 70px;" /><!-- Gezahlt -->
            <col style="width: 70px;" /><!-- Rest -->
            <% } %>
          </colgroup>
          <thead>
            <tr>
              <th><span class="head-label">Name</span></th>
              <th><span class="head-label">Anwesend</span></th>
              <th><span class="head-label">Übertrag</span></th>
              <th><span class="head-label">Beitrag</span></th>
              <th><span class="head-label">Strafen</span></th>
              <th title="Alle 9"><span class="head-label">9er</span></th>
              <th title="Kranz"><span class="head-label">Kränze</span></th>
              <th><span class="head-label">Triclops</span></th>
              <th><span class="head-label">Pudel</span></th>
              <th class="game-col"><span class="head-label">V+A</span></th>
              <th class="game-col"><span class="head-label">Monte<br><br><span class="head-sub">(Extrapunkt)</span></span></th>
              <th class="game-col"><span class="head-label">Aussteigen</span></th>
              <th class="game-col"><span class="head-label">6-Tage-Rennen</span></th>
              <% customGames.forEach((cg) => { %>
              <th class="game-col"><span class="head-label"><%= cg.name %></span></th>
              <% }) %>
              <% if (status <= 1) { %>
              <th class="game-col"><input type="text" class="custom-game-header-input" placeholder="Neues Spiel..." data-new-game-header /></th>
              <% } %>
              <th><span class="head-label">Zu zahlen</span></th>
              <% if (status >= 2) { %>
              <th><span class="head-label">Gezahlt</span></th>
              <th><span class="head-label">Rest</span></th>
              <% } %>
            </tr>
          </thead>
          <tbody>
            <% members.forEach((member, i) => {
              const hit = attendanceMap.get(member.id) || { present: 0, penalties: 0, contribution: 0, pudel: 0, alle9: 0, kranz: 0, triclops: 0, carryover: 0, paid: 0 };
              const pudel = Number(hit.pudel || 0);
              const alle9 = Number(hit.alle9 || 0);
              const kranz = Number(hit.kranz || 0);
              const triclops = Number(hit.triclops || 0);
              const canEditMarks = status <= 1;
              const canEditPresent = canEditMarks;
              const isEditable = canEditMarks;
              const canEdit = canEditMarks && hit.present;
              const canEditPaid = status === 2;
            %>
              <tr data-member-id="<%= member.id %>" class="<%= hit.present ? '' : 'row-inactive' %>">
                <%
                  const carryover = Number(hit.carryover || 0);
                %>
                <td class="name-col"><%= member.display_name %></td>
                <td class="present-col">
                  <label class="present-toggle" title="Anwesend">
                    <input type="checkbox" name="present_<%= member.id %>" <%= hit.present ? "checked" : "" %> <%= isEditable ? "" : "disabled" %> data-present />
                    <img src="/sheep.png" alt="Anwesend" class="present-icon" />
                  </label>
                </td>
                <td data-label="Übertrag">
                  <span class="money-text" data-carryover data-value="<%= carryover %>"><%= formatEuro(carryover) %> &euro;</span>
                </td>
                <td data-label="Beitrag">
                  <span class="money-text"><%= formatEuro(hit.contribution || 0) %> €</span>
                </td>
                <td data-label="Strafen"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= Number(hit.penalties || 0).toFixed(2) %>" name="penalties_<%= member.id %>" class="mini-number no-spin" <%= isEditable ? "" : "disabled" %> data-field data-always-edit />&euro;</span></td>
                <td class="marker-cell" data-label="9er">
                  <div class="marker-controls">
                    <input type="hidden" name="alle9_<%= member.id %>" value="<%= alle9 %>" data-marker-input="alle9" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="alle9" data-op="dec" aria-label="Alle 9 verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="alle9"><%- renderTally(alle9) %></span>
                    <button type="button" class="mark-btn" data-mark-target="alle9" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costAlle9 = hit.present ? (totalAlle9Present - alle9) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="alle9"><%= costAlle9 > 0 ? formatEuro(costAlle9) + ' €' : '' %></span>
                </td>
                <td class="marker-cell" data-label="Kränze">
                  <div class="marker-controls">
                    <input type="hidden" name="kranz_<%= member.id %>" value="<%= kranz %>" data-marker-input="kranz" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="kranz" data-op="dec" aria-label="Kranz verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="kranz"><%- renderTally(kranz) %></span>
                    <button type="button" class="mark-btn" data-mark-target="kranz" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costKranz = hit.present ? (totalKranzPresent - kranz) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="kranz"><%= costKranz > 0 ? formatEuro(costKranz) + ' €' : '' %></span>
                </td>
                <td class="marker-cell" data-label="Triclops">
                  <div class="marker-controls">
                    <input type="hidden" name="triclops_<%= member.id %>" value="<%= triclops %>" data-marker-input="triclops" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="triclops" data-op="dec" aria-label="Triclops verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="triclops"><%- renderTally(triclops) %></span>
                    <button type="button" class="mark-btn" data-mark-target="triclops" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costTriclops = hit.present ? (totalTriclopsPresent - triclops) * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="triclops"><%= costTriclops > 0 ? formatEuro(costTriclops) + ' €' : '' %></span>
                </td>
                <td class="marker-cell" data-label="Pudel">
                  <div class="marker-controls">
                    <input type="hidden" name="pudel_<%= member.id %>" value="<%= pudel %>" data-marker-input="pudel" <%= canEdit ? "" : "disabled" %> data-field />
                    <button type="button" class="mark-btn mark-dec" data-mark-target="pudel" data-op="dec" aria-label="Pudel verringern" <%= canEdit ? "" : "disabled" %> data-field-btn></button>
                    <span class="marker-strip" data-marker-display="pudel"><%- renderTally(pudel) %></span>
                    <button type="button" class="mark-btn" data-mark-target="pudel" data-op="inc" <%= canEdit ? "" : "disabled" %> data-field-btn>+</button>
                  </div>
                  <% const costPudel = hit.present ? pudel * 0.10 : 0; %>
                  <span class="marker-cost" data-cost-type="pudel"><%= costPudel > 0 ? formatEuro(costPudel) + ' €' : '' %></span>
                </td>
                <%
                  const vaVal = Number(hit.va || 0);
                  const monteVal = Number(hit.monte || 0);
                  const aussteigenVal = Number(hit.aussteigen || 0);
                  const sechsTageVal = Number(hit.sechs_tage || 0);
                %>
                <td class="game-col" data-label="V+A"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= vaVal.toFixed(2) %>" name="va_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;</span></td>
                <td class="game-col" data-label="Monte"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= monteVal.toFixed(2) %>" name="monte_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;<input type="radio" name="monte_extra" value="<%= member.id %>" class="monte-extra-radio" <%= hit.monte_extra ? 'checked' : '' %> <%= canEdit ? '' : 'disabled' %> data-monte-extra title="Extrapunkt" /></span><input type="hidden" name="monte_tiebreak_<%= member.id %>" value="<%= Number(hit.monte_tiebreak || 0) %>" data-tiebreak="monte" /></td>
                <td class="game-col" data-label="Aussteigen"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= aussteigenVal.toFixed(2) %>" name="aussteigen_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;</span><input type="hidden" name="aussteigen_tiebreak_<%= member.id %>" value="<%= Number(hit.aussteigen_tiebreak || 0) %>" data-tiebreak="aussteigen" /></td>
                <td class="game-col" data-label="6-Tage"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= sechsTageVal.toFixed(2) %>" name="sechs_tage_<%= member.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-game-field />&euro;</span></td>
                <% customGames.forEach((cg) => {
                  const cgVal = Number(customGameValues.get(member.id + '_' + cg.id) || 0);
                %>
                <td class="game-col" data-label="<%= cg.name %>"><span class="money-inline"><input type="number" min="0" max="999" step="0.10" value="<%= cgVal.toFixed(2) %>" data-custom-game-id="<%= cg.id %>" class="mini-number no-spin game-col-input" <%= canEdit ? "" : "disabled" %> data-field data-custom-game-field />&euro;</span></td>
                <% }) %>
                <% if (status <= 1) { %>
                <td class="game-col newgame-placeholder"></td>
                <% } %>
                <%
                  const paid = Number(hit.paid || 0);
                  const pudelCostCalc = hit.present ? pudel * 0.10 : 0;
                  const alle9CostCalc = hit.present ? (totalAlle9Present - alle9) * 0.10 : 0;
                  const kranzCostCalc = hit.present ? (totalKranzPresent - kranz) * 0.10 : 0;
                  const triclopsCostCalc = hit.present ? (totalTriclopsPresent - triclops) * 0.10 : 0;
                  const gameCosts = hit.present ? vaVal + monteVal + aussteigenVal + sechsTageVal : 0;
                  let customGameTotal = 0;
                  if (hit.present) {
                    customGames.forEach((cg) => {
                      customGameTotal += Number(customGameValues.get(member.id + '_' + cg.id) || 0);
                    });
                  }
                  const toPay = hit.present ? (hit.contribution || 0) + (hit.penalties || 0) + pudelCostCalc + alle9CostCalc + kranzCostCalc + triclopsCostCalc + gameCosts + customGameTotal + carryover : (hit.contribution || 0) + (hit.penalties || 0) + carryover;
                  const rest = toPay - paid;
                %>
                <td class="topay-col" data-label="Zu zahlen">
                  <span class="money-text" data-topay><%= formatEuro(toPay) %> &euro;</span>
                </td>
                <% if (status >= 2) { %>
                <td data-label="Gezahlt">
                  <% if (canEditPaid) { %>
                    <span class="money-inline"><input type="number" min="0" max="9999" step="0.10" value="<%= paid.toFixed(2) %>" name="paid_<%= member.id %>" class="mini-number no-spin" data-paid-field data-always-edit />&euro;</span>
                  <% } else { %>
                    <span class="money-text" data-paid data-value="<%= paid %>"><%= formatEuro(paid) %> &euro;</span>
                  <% } %>
                </td>
                <td data-label="Rest">
                  <span class="money-text" data-rest><%= formatEuro(rest) %> &euro;</span>
                </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
    </div>
    </div>

    <!-- Footer: Status + Kassenstand-Aufstellung -->
    <div class="kladde-footer">
      <div class="settle-row">
        <p>
          Status:
          <span class="badge <%= statusBadges[status] %>"><%= statusLabels[status] %></span>
        </p>
        <div class="settle-actions">
          <% if (status > 0) { %>
            <form method="post" action="/kegelkladde/revert-status" data-confirm="Status wirklich zurücksetzen?">
              <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
              <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
              <button type="submit" class="btn-secondary btn-sm">&laquo; Zurück</button>
            </form>
          <% } %>
          <% if (status >= 1 && status < 3) { %>
            <form method="post" action="/kegelkladde/advance-status" data-confirm="<%= advanceLabels[status] %>?">
              <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
              <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
              <button type="submit" class="btn-primary btn-sm"><%= advanceLabels[status] %> &raquo;</button>
            </form>
          <% } %>
          <% if (isAdmin) { %>
            <form method="post" action="/kegelkladde/delete" data-confirm="Spieltag wirklich löschen? Alle Daten gehen verloren!">
              <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
              <input type="hidden" name="gamedayId" value="<%= selectedGameday.id %>" />
              <button type="submit" class="btn-danger btn-sm">Löschen</button>
            </form>
          <% } %>
        </div>
      </div>

      <div class="kassenstand-summary" id="kassenstandSummary"
           data-gameday-id="<%= selectedGameday.id %>"
           data-csrf="<%= csrfToken %>"
           data-status="<%= status %>">
        <table class="kassenstand-table">
          <tbody>
            <tr>
              <td>Alter Kassenstand:</td>
              <td class="ks-value" id="ksPrev"><%= formatEuro(ksGameday.previousKassenstand) %> &euro;</td>
            </tr>
            <tr>
              <td>+ Einnahmen:</td>
              <td class="ks-value ks-plus" id="ksPaid">+<%= formatEuro(ksGameday.gamedayPaid) %> &euro;</td>
            </tr>
            <% ksGameday.incomeItems.forEach((ci) => { %>
            <tr class="ks-entry-row" data-entry-id="<%= ci.id %>">
              <td>+ <%= ci.name %>:</td>
              <td class="ks-value ks-plus">
                <% if (status <= 2) { %>
                  <span class="money-inline">+<input type="number" min="0" max="9999" step="0.01" value="<%= Number(ci.amount).toFixed(2) %>" class="mini-number no-spin ks-entry-input" data-entry-id="<%= ci.id %>" />&euro;</span>
                <% } else { %>
                  +<%= formatEuro(ci.amount) %> &euro;
                <% } %>
              </td>
            </tr>
            <% }) %>
            <% if (status <= 2) { %>
            <tr class="ks-new-entry">
              <td colspan="2">
                <input type="text" class="ks-new-entry-input" placeholder="Neue Einnahme..." maxlength="40" data-entry-type="income" />
              </td>
            </tr>
            <% } %>
            <% ksGameday.costItems.forEach((ci) => { %>
            <tr class="ks-entry-row" data-entry-id="<%= ci.id %>">
              <td>&minus; <%= ci.name %>:</td>
              <td class="ks-value ks-minus">
                <% if (status <= 2) { %>
                  <span class="money-inline">&minus;<input type="number" min="0" max="9999" step="0.01" value="<%= Number(ci.amount).toFixed(2) %>" class="mini-number no-spin ks-entry-input" data-entry-id="<%= ci.id %>" />&euro;</span>
                <% } else { %>
                  &minus;<%= formatEuro(ci.amount) %> &euro;
                <% } %>
              </td>
            </tr>
            <% }) %>
            <% if (status <= 2) { %>
            <tr class="ks-new-entry">
              <td colspan="2">
                <input type="text" class="ks-new-entry-input" placeholder="Neue Kosten..." maxlength="40" data-entry-type="cost" />
              </td>
            </tr>
            <% } %>
            <tr class="ks-divider"><td colspan="2"></td></tr>
            <tr class="ks-total">
              <td>= Neuer Kassenstand:</td>
              <td class="ks-value" id="ksTotal"><%= formatEuro(ksGameday.kassenstand) %> &euro;</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  <% } %>
</section>

<%- include("partials/bottom") %>
