<%- include("partials/top") %>
<section class="card fade-in">
  <div class="section-head">
    <h1>Mitglieder</h1>
    <p class="subtle">Alle Vereinsmitglieder auf einen Blick.</p>
  </div>

  <% if (isAdmin) { %>
    <div class="member-top-actions">
      <button class="btn" onclick="document.getElementById('createMemberModal').classList.add('active')">Mitglied anlegen</button>
      <button class="btn btn-secondary" onclick="document.getElementById('createGuestModal').classList.add('active')">Gast anlegen</button>
    </div>
  <% } %>

  <!-- Desktop: Tabellen-Header -->
  <div class="member-grid-header desktop-only <%= isAdmin ? 'has-admin' : '' %>">
    <% if (isAdmin) { %><span></span><% } %>
    <span></span>
    <span>Name</span>
    <span>E-Mail</span>
    <span>Adresse</span>
    <span>Telefon</span>
    <% if (isAdmin) { %><span></span><% } %>
  </div>

  <ul class="member-list-new">
    <% members.forEach((m, idx) => { %>
      <li class="member-card <%= m.is_guest ? 'member-card-guest' : '' %>" data-id="<%= m.id %>" <% if (isAdmin) { %>draggable="true"<% } %>>
        <% if (isAdmin) { %>
          <span class="drag-handle" title="Reihenfolge aendern">&#9776;</span>
        <% } %>
        <div class="member-card-avatar">
          <% if (m.avatar) { %>
            <img src="/uploads/avatars/<%= m.avatar %>" alt="" class="member-avatar" />
          <% } else { %>
            <span class="member-avatar member-avatar-initials"><%= m.first_name ? m.first_name[0].toUpperCase() : '' %><%= m.last_name ? m.last_name[0].toUpperCase() : '' %></span>
          <% } %>
        </div>
        <div class="member-col member-col-name">
          <strong><%= m.first_name %><%= m.last_name ? ` ${m.last_name}` : "" %></strong>
          <% if (m.role === 'admin') { %><span class="badge badge-success">Admin</span><% } %>
          <% if (m.is_guest) { %><span class="badge badge-muted">Gast</span><% } %>
        </div>
        <% if (!m.is_guest) { %>
          <div class="member-col member-col-email" data-label="E-Mail"><% if (m.email) { %><a href="mailto:<%= m.email %>"><%= m.email %></a><% } else { %>–<% } %></div>
          <div class="member-col member-col-address copyable" data-label="Adresse"><%= m.address || '–' %></div>
          <div class="member-col member-col-phone copyable" data-label="Telefon"><%= (m.phones && m.phones.length) ? m.phones.join(" | ") : '–' %></div>
        <% } else { %>
          <div class="member-col member-col-guest-spacer"></div>
        <% } %>
        <% if (isAdmin) { %>
          <div class="member-card-actions">
            <button class="btn btn-sm btn-secondary" onclick="openEditMember(<%= m.id %>)" title="Bearbeiten">&#9998;</button>
            <% if (m.id !== currentUser.id) { %>
              <form method="post" action="/members/delete" data-confirm="Mitglied <%= m.first_name %> wirklich loeschen? Alle zugehoerigen Daten werden entfernt!" style="display:inline;">
                <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
                <input type="hidden" name="memberId" value="<%= m.id %>" />
                <button type="submit" class="btn btn-sm btn-danger" title="Loeschen">&#10005;</button>
              </form>
            <% } %>
          </div>
        <% } %>
      </li>
    <% }) %>
  </ul>

  <% if (isAdmin) { %>
    <!-- Reihenfolge speichern (hidden form) -->
    <form method="post" action="/kegelkladde/member-order" id="orderForm" style="display: none;">
      <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
      <input type="hidden" name="memberOrder" id="memberOrder" value="" />
    </form>

    <!-- Edit Member Modal -->
    <div class="modal-overlay" id="editMemberModal">
      <div class="modal" style="max-width: 520px;">
        <h3>Mitglied bearbeiten</h3>
        <form method="post" action="/members/admin-update" class="form-grid" id="editMemberForm">
          <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
          <input type="hidden" name="memberId" id="editMemberId" value="" />
          <div class="form-row-2">
            <label>Benutzername
              <input name="username" id="editUsername" required maxlength="40" />
            </label>
            <label>Rolle
              <select name="role" id="editRole">
                <option value="user">Benutzer</option>
                <option value="admin">Administrator</option>
              </select>
            </label>
          </div>
          <div class="form-row-2">
            <label>Vorname
              <input name="firstName" id="editFirstName" required maxlength="60" />
            </label>
            <label>Nachname
              <input name="lastName" id="editLastName" maxlength="60" />
            </label>
          </div>
          <label>Adresse (optional)
            <textarea name="address" id="editAddress" maxlength="200" rows="3"></textarea>
          </label>
          <label>E-Mail (optional)
            <input type="email" name="email" id="editEmail" maxlength="120" />
          </label>
          <label>Telefone (optional, 1-3, per Komma)
            <input name="phones" id="editPhones" maxlength="120" />
          </label>
          <div class="member-actions">
            <button type="submit">Speichern</button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('editMemberModal').classList.remove('active')">Abbrechen</button>
          </div>
        </form>
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--line);">
          <h4 style="margin: 0 0 0.5rem;">Passwort zuruecksetzen</h4>
          <form method="post" action="/members/reset-password" class="inline-row">
            <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
            <input type="hidden" name="memberId" id="resetPwMemberId" value="" />
            <input type="password" name="newPassword" required minlength="8" placeholder="Neues Passwort" />
            <button type="submit" class="btn-secondary">Zuruecksetzen</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Create Member Modal -->
    <div class="modal-overlay" id="createMemberModal">
      <div class="modal" style="max-width: 520px;">
        <h3>Neues Mitglied anlegen</h3>
        <form method="post" action="/members/create" class="form-grid">
          <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
          <div class="form-row-2">
            <label>Benutzername
              <input name="username" placeholder="Benutzername" required maxlength="40" autocomplete="off" />
            </label>
            <label>Start-Passwort
              <input type="password" name="password" placeholder="min. 8 Zeichen" required minlength="8" autocomplete="new-password" />
            </label>
          </div>
          <div class="form-row-2">
            <label>Vorname
              <input name="firstName" placeholder="Vorname" required maxlength="60" />
            </label>
            <label>Nachname (optional)
              <input name="lastName" placeholder="Nachname" maxlength="60" />
            </label>
          </div>
          <label>Rolle
            <select name="role">
              <option value="user">Benutzer</option>
              <option value="admin">Administrator</option>
            </select>
          </label>
          <div class="member-actions">
            <button type="submit">Anlegen</button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('createMemberModal').classList.remove('active')">Abbrechen</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Create Guest Modal -->
    <div class="modal-overlay" id="createGuestModal">
      <div class="modal" style="max-width: 420px;">
        <h3>Gast anlegen</h3>
        <p class="subtle">Gaeste koennen sich nicht einloggen, erscheinen aber in der Kegelkladde.</p>
        <form method="post" action="/members/create-guest" class="form-grid">
          <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
          <div class="form-row-2">
            <label>Vorname
              <input name="firstName" placeholder="Vorname" required maxlength="60" />
            </label>
            <label>Nachname (optional)
              <input name="lastName" placeholder="Nachname" maxlength="60" />
            </label>
          </div>
          <div class="member-actions">
            <button type="submit">Gast hinzufuegen</button>
            <button type="button" class="btn-secondary" onclick="document.getElementById('createGuestModal').classList.remove('active')">Abbrechen</button>
          </div>
        </form>
      </div>
    </div>
  <% } %>
</section>

<% if (isAdmin) { %>
<script>
  // Member data for edit modal
  const memberData = <%- JSON.stringify(members.map(m => ({
    id: m.id,
    username: m.username,
    role: m.role,
    first_name: m.first_name,
    last_name: m.last_name,
    address: m.address,
    email: m.email,
    phones: (m.phones || []).join(", ")
  }))) %>;

  function openEditMember(id) {
    const m = memberData.find(x => x.id === id);
    if (!m) return;
    document.getElementById('editMemberId').value = m.id;
    document.getElementById('resetPwMemberId').value = m.id;
    document.getElementById('editUsername').value = m.username;
    document.getElementById('editFirstName').value = m.first_name;
    document.getElementById('editLastName').value = m.last_name;
    document.getElementById('editAddress').value = m.address || '';
    document.getElementById('editEmail').value = m.email || '';
    document.getElementById('editPhones').value = m.phones || '';
    const roleSelect = document.getElementById('editRole');
    roleSelect.value = m.role;
    // Lock role for user ID 1
    roleSelect.disabled = (m.id === 1);
    document.getElementById('editMemberModal').classList.add('active');
  }

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.classList.remove('active');
    });
  });
</script>
<% } %>
<%- include("partials/bottom") %>
