<%- include('partials/top') %>

<h1>Pinnwand</h1>

<div class="card" style="margin-bottom: 1.5rem;">
  <form method="post" action="/pinnwand/add" enctype="multipart/form-data">
    <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />

    <div style="margin-bottom: 0.75rem;">
      <textarea name="message" rows="3" placeholder="Nachricht schreiben..." required maxlength="1000"
        style="width: 100%; padding: 0.5rem; border: 1px solid var(--line); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.95rem; resize: vertical;"></textarea>
    </div>

    <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 1rem;">
      <div class="pin-color-picker">
        <span style="font-size: 0.85rem; color: var(--muted); margin-right: 0.25rem;">Farbe:</span>
        <label class="pin-color-dot" style="background: #fff9c4;" title="Gelb">
          <input type="radio" name="color" value="#fff9c4" checked />
        </label>
        <label class="pin-color-dot" style="background: #c8e6c9;" title="GrÃ¼n">
          <input type="radio" name="color" value="#c8e6c9" />
        </label>
        <label class="pin-color-dot" style="background: #bbdefb;" title="Blau">
          <input type="radio" name="color" value="#bbdefb" />
        </label>
        <label class="pin-color-dot" style="background: #f8bbd0;" title="Rosa">
          <input type="radio" name="color" value="#f8bbd0" />
        </label>
        <label class="pin-color-dot" style="background: #e1bee7;" title="Lila">
          <input type="radio" name="color" value="#e1bee7" />
        </label>
        <label class="pin-color-dot" style="background: #ffe0b2;" title="Orange">
          <input type="radio" name="color" value="#ffe0b2" />
        </label>
      </div>

      <label class="btn btn-secondary" style="cursor: pointer; font-size: 0.85rem;">
        <span class="pin-file-label">Bild anhÃ¤ngen</span>
        <input type="file" name="image" accept=".jpg,.jpeg,.png,.gif,.webp" style="display: none;" onchange="this.previousElementSibling.textContent = this.files[0] ? this.files[0].name : 'Bild anhÃ¤ngen'" />
      </label>

      <button type="submit" class="btn btn-primary" style="margin-left: auto;">Nachricht posten</button>
    </div>
  </form>
</div>

<% if (messages.length === 0) { %>
  <p style="text-align: center; color: var(--muted); margin-top: 2rem;">Noch keine Nachrichten. Schreib die erste!</p>
<% } else { %>
  <div class="pin-board" data-csrf="<%= csrfToken %>" data-user-id="<%= currentUser?.id %>">
    <% messages.forEach((msg, i) => { %>
      <div class="pin-card<%= msg.user_id === currentUser?.id ? ' pin-card-own' : '' %><%= msg.card_style ? ' pin-style-' + msg.card_style : '' %>"
           data-pin-id="<%= msg.id %>"
           data-owner-id="<%= msg.user_id %>"
           data-has-pos="<%= msg.pos_x != null ? '1' : '0' %>"
           style="background: <%= msg.color %>;<% if (msg.pos_x != null) { %> left: <%= msg.pos_x %>%; top: <%= msg.pos_y %>%; transform: rotate(<%= msg.rotation %>deg);<% } %>">
        <div class="pin-card-message"><%= msg.message %></div>

        <% if (msg.image_path) { %>
          <img src="/uploads/pinnwand/<%= msg.image_path %>" alt="Bild" class="pin-card-image" />
        <% } %>

        <div class="pin-card-footer">
          <span class="pin-card-author"><%= msg.display_name %></span>
          <span class="pin-card-date"><%= new Date(msg.created_at + 'Z').toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' }) %></span>
        </div>

        <% if (msg.user_id === currentUser?.id) { %>
          <button type="button" class="pin-rotate-handle" title="Drehen">â†»</button>
          <button type="button" class="pin-ontop-handle" title="Nach vorne">&#9733;</button>
          <div class="pin-style-buttons">
            <% const styles = [
              { key: '', icon: 'â†º', title: 'Standard' },
              { key: 'polaroid', icon: 'â¬œ', title: 'Polaroid' },
              { key: 'vintage', icon: 'â˜•', title: 'Vintage' },
              { key: 'neon', icon: 'ðŸ’¡', title: 'Neon' },
              { key: 'doodle', icon: 'âœ', title: 'Doodle' },
              { key: 'frame', icon: 'ðŸ–¼', title: 'Rahmen' },
              { key: 'dark', icon: 'ðŸŒ‘', title: 'Tafel' },
              { key: 'glass', icon: 'ðŸ’Ž', title: 'Glas' },
              { key: 'wobble', icon: 'ðŸŒŠ', title: 'Wackeln' },
              { key: 'elegant', icon: 'ðŸ‘‘', title: 'Edel' },
              { key: 'retro', icon: 'ðŸ’š', title: 'Retro' },
              { key: 'tape', icon: 'ðŸ“Œ', title: 'Gepinnt' },
              { key: 'shadow', icon: 'ðŸ•¶', title: 'Schatten' }
            ];
            styles.forEach(s => { %>
              <button type="button" class="pin-style-btn<%= (msg.card_style || '') === s.key ? ' active' : '' %>" data-style="<%= s.key %>" title="<%= s.title %>"><%= s.icon %></button>
            <% }) %>
          </div>
        <% } %>

        <% if (msg.user_id === currentUser?.id || isAdmin) { %>
          <form method="post" action="/pinnwand/delete" class="pin-card-delete">
            <input type="hidden" name="csrfToken" value="<%= csrfToken %>" />
            <input type="hidden" name="pinId" value="<%= msg.id %>" />
            <button type="submit" title="LÃ¶schen" onclick="return confirm('Nachricht wirklich lÃ¶schen?')">âœ•</button>
          </form>
        <% } %>
      </div>
    <% }) %>
  </div>
<% } %>

<!-- Lightbox overlay -->
<div id="pinLightbox" class="lightbox-overlay" style="display: none;">
  <img id="pinLightboxImg" src="" alt="Vollbild" />
</div>

<%- include('partials/bottom') %>
