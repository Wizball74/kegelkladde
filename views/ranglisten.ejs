<%- include("partials/top") %>
<%
  const renderCrowns = (wins) => {
    if (wins <= 0) return '';
    return '\u{1F451}' + wins;
  };
%>
<script type="application/json" id="celebrateData"><%- JSON.stringify(celebrateItems) %></script>
<script type="application/json" id="ranglistenData"><%- JSON.stringify({
  monte: monteRanking.map(p => ({
    name: p.display_name,
    total: p.total,
    wins: p.wins,
    carryover: p.carryover || 0,
    perGameday: p.perGameday
  })),
  medaillen: medaillenRanking.map(p => ({
    name: p.display_name,
    total: p.total,
    wins: p.wins,
    carryover: p.carryover || 0,
    perGameday: p.perGameday
  })),
  monteTarget: 100,
  medaillenTarget: 41
}) %></script>
<section class="card fade-in">
  <div class="section-head">
    <h1>Ranglisten</h1>
    <p class="subtle">Punktest&auml;nde aus Monte und Aussteigen.</p>
  </div>

  <% if (gamedays.length > 0) { %>
    <div class="ranglisten-gameday-select" style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
      <label style="display:inline-flex; align-items:center; gap:0.5rem; font-size:0.9rem;">
        Spieltag:
        <select id="ranglistenGameday" style="font-weight:600;">
          <option value="">Keiner</option>
          <% gamedays.forEach((gd) => { %>
            <option value="<%= gd.id %>" <%= selectedGameday && selectedGameday.id === gd.id ? 'selected' : '' %>>
              <%= formatDateDE(gd.match_date) %><%= gd.note ? ` - ${gd.note}` : '' %>
            </option>
          <% }) %>
        </select>
      </label>
      <label class="ranglisten-view-toggle" style="display:inline-flex; align-items:center; gap:0.5rem; font-size:0.85rem; cursor:pointer;">
        <input type="checkbox" id="ranglistenSingleDay" style="cursor:pointer;" />
        Nur ausgew&auml;hlter Spieltag
      </label>
    </div>
  <% } %>

  <!-- Tabs -->
  <nav class="tab-nav">
    <button type="button" class="tab-btn active" data-tab="monte">Monte</button>
    <button type="button" class="tab-btn" data-tab="medaillen">Medaillen</button>
    <button type="button" class="tab-btn" data-tab="historie">Rundenverlauf</button>
  </nav>

  <!-- Tab: Monte -->
  <div class="tab-panel active" id="tab-monte">
    <%
      const maxMonte = monteRanking.length > 0 ? Math.max(monteRanking[0].total, 1) : 1;
      const monteTarget = 100;
      const barCeil = Math.max(maxMonte, monteTarget);
    %>
    <% if (monteRanking.length > 0) { %>
      <div class="hbar-chart" style="--target-pct: <%= (monteTarget / barCeil) * 100 %>%;">
        <% monteRanking.forEach((player, i) => {
          const pct = (player.total / barCeil) * 100;
          const hlEntry = selectedGameday
            ? player.perGameday.find(e => e.gamedayId === selectedGameday.id)
            : null;
          const hlPts = hlEntry ? hlEntry.points : 0;
          const carry = player.carryover || 0;
          const gamePts = player.total - hlPts - carry;
        %>
          <div class="hbar-row">
            <div class="hbar-label">
              <span class="hbar-rank"><%= i + 1 %></span>
              <span class="hbar-name"><%= player.display_name %></span>
            </div>
            <div class="hbar-crowns"><%- player.wins > 0 ? renderCrowns(player.wins) : '' %></div>
            <div class="hbar-track">
              <div class="hbar-fill" style="width: <%= pct %>%;">
                <% if (carry > 0) { %>
                  <div class="hbar-seg hbar-carry" style="flex: <%= carry %>;"></div>
                <% } %>
                <% if (gamePts > 0) { %>
                  <div class="hbar-seg hbar-base" style="flex: <%= gamePts %>;"></div>
                <% } %>
                <% if (hlPts > 0) { %>
                  <div class="hbar-seg hbar-hl" style="flex: <%= hlPts %>;"></div>
                <% } %>
                <span class="hbar-inline-value"><%= player.total %></span>
              </div>
              <div class="hbar-target"></div>
            </div>
          </div>
        <% }) %>
      </div>
      <div class="hbar-legend">
        <% if (hasMonteCarryover) { %><span class="hbar-legend-item"><span class="bar-legend-swatch hbar-carry"></span>&Uuml;bertrag</span><% } %>
        <span class="hbar-legend-item"><span class="bar-legend-swatch hbar-base"></span>Spieltage</span>
        <% if (selectedGameday) { %><span class="hbar-legend-item"><span class="bar-legend-swatch hbar-hl"></span><%= formatDateDE(selectedGameday.match_date).replace(/\d{2}(\d{2})$/, '$1') %></span><% } %>
        <span class="hbar-legend-item hbar-legend-goal">Ziel = 100</span>
      </div>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-state-icon">&#127922;</div>
        <p>Noch keine Monte-Ergebnisse vorhanden.</p>
      </div>
    <% } %>
  </div>

  <!-- Tab: Medaillen -->
  <div class="tab-panel" id="tab-medaillen">
    <%
      const maxMedaillen = medaillenRanking.length > 0 ? Math.max(medaillenRanking[0].total, 1) : 1;
      const medTarget = 41;
      const medCeil = Math.max(maxMedaillen, medTarget);
    %>
    <% if (medaillenRanking.length > 0) { %>
      <div class="hbar-chart" style="--target-pct: <%= (medTarget / medCeil) * 100 %>%;">
        <% medaillenRanking.forEach((player, i) => {
          const pct = (player.total / medCeil) * 100;
          const hlEntry = selectedGameday
            ? player.perGameday.find(e => e.gamedayId === selectedGameday.id)
            : null;
          const hlPts = hlEntry ? hlEntry.points : 0;
          const carry = player.carryover || 0;
          const gamePts = player.total - hlPts - carry;
        %>
          <div class="hbar-row">
            <div class="hbar-label">
              <span class="hbar-rank"><%= i + 1 %></span>
              <span class="hbar-name"><%= player.display_name %></span>
            </div>
            <div class="hbar-crowns"><%- player.wins > 0 ? renderCrowns(player.wins) : '' %></div>
            <div class="hbar-track">
              <div class="hbar-fill" style="width: <%= pct %>%;">
                <% if (carry > 0) { %>
                  <div class="hbar-seg hbar-carry" style="flex: <%= carry %>;"></div>
                <% } %>
                <% if (gamePts > 0) { %>
                  <div class="hbar-seg hbar-base" style="flex: <%= gamePts %>;"></div>
                <% } %>
                <% if (hlPts > 0) { %>
                  <div class="hbar-seg hbar-hl" style="flex: <%= hlPts %>;"></div>
                <% } %>
                <span class="hbar-inline-value"><%= player.total %></span>
              </div>
              <div class="hbar-target"></div>
            </div>
          </div>
        <% }) %>
      </div>
      <div class="hbar-legend">
        <span class="hbar-legend-item"><span class="bar-legend-swatch hbar-carry"></span>&Uuml;bertrag</span>
        <span class="hbar-legend-item"><span class="bar-legend-swatch hbar-base"></span>Spieltage</span>
        <% if (selectedGameday) { %><span class="hbar-legend-item"><span class="bar-legend-swatch hbar-hl"></span><%= formatDateDE(selectedGameday.match_date).replace(/\d{2}(\d{2})$/, '$1') %></span><% } %>
        <span class="hbar-legend-item hbar-legend-goal">Ziel = 41</span>
      </div>
    <% } else { %>
      <div class="empty-state">
        <div class="empty-state-icon">&#127942;</div>
        <p>Noch keine Medaillen-Ergebnisse vorhanden.</p>
      </div>
    <% } %>
  </div>

  <!-- Tab: Rundenverlauf -->
  <div class="tab-panel" id="tab-historie">
    <% if (monteHistory.length === 0 && medaillenHistory.length === 0) { %>
      <div class="empty-state">
        <div class="empty-state-icon">&#128220;</div>
        <p>Noch keine abgeschlossenen Runden.</p>
      </div>
    <% } else { %>
      <% if (monteHistory.length > 0) { %>
        <h2 style="margin-top:0;">Monte-Siege</h2>
        <div class="round-history-list">
          <% monteHistory.forEach((rw) => {
            let standings = [];
            try { standings = JSON.parse(rw.standings_json); } catch(e) {}
          %>
            <details class="round-history-item">
              <summary>
                <span class="round-badge">Runde <%= rw.round_number %></span>
                <span class="round-winner-name"><%= rw.first_name %></span>
                <span class="round-score"><%= rw.winning_score %> Pkt.</span>
                <span class="round-date"><%= formatDateDE(rw.match_date) %></span>
              </summary>
              <ol class="round-standings">
                <% standings.forEach((s, idx) => { %>
                  <li class="<%= s.total === rw.winning_score ? 'round-winner' : '' %>">
                    <span class="round-standing-name"><%= s.name %></span>
                    <span class="round-standing-pts"><%= s.total %> Pkt.</span>
                  </li>
                <% }) %>
              </ol>
            </details>
          <% }) %>
        </div>
      <% } %>

      <% if (medaillenHistory.length > 0) { %>
        <h2>Medaillen-Siege</h2>
        <div class="round-history-list">
          <% medaillenHistory.forEach((rw) => {
            let standings = [];
            try { standings = JSON.parse(rw.standings_json); } catch(e) {}
          %>
            <details class="round-history-item">
              <summary>
                <span class="round-badge">Runde <%= rw.round_number %></span>
                <span class="round-winner-name"><%= rw.first_name %></span>
                <span class="round-score"><%= rw.winning_score %> Pkt.</span>
                <span class="round-date"><%= formatDateDE(rw.match_date) %></span>
              </summary>
              <ol class="round-standings">
                <% standings.forEach((s, idx) => { %>
                  <li class="<%= s.total === rw.winning_score ? 'round-winner' : '' %>">
                    <span class="round-standing-name"><%= s.name %></span>
                    <span class="round-standing-pts"><%= s.total %> Pkt.<%= s.medals != null ? ` (${s.medals} Med.)` : '' %></span>
                  </li>
                <% }) %>
              </ol>
            </details>
          <% }) %>
        </div>
      <% } %>
    <% } %>
  </div>
</section>
<%- include("partials/bottom") %>
