<%- include("partials/top") %>
<%
  const formatEuro = (value) => Number(value || 0).toFixed(2).replace(".", ",");
%>
<section class="card fade-in">
  <div class="section-head">
    <h1>Statistik</h1>
    <p class="subtle">Übersicht über alle Vereinsaktivitäten und Bestenlisten.</p>
  </div>

  <!-- Tabs -->
  <nav class="tab-nav">
    <button type="button" class="tab-btn active" data-tab="neuner-kraenze">Neuner / Kränze</button>
    <button type="button" class="tab-btn" data-tab="allgemein">Allgemein</button>
  </nav>

  <!-- Tab: Neuner / Kränze -->
  <div class="tab-panel active" id="tab-neuner-kraenze">
    <div class="split-grid">
      <div>
        <h2 style="margin-top: 0;">Neuner (Alle 9)</h2>
        <% if (neunerStats.length > 0) { %>
          <div class="records-table-wrap">
            <table class="records-table sortable-table">
              <thead>
                <tr>
                  <th data-sort="string">Name</th>
                  <th data-sort="number">Gesamt</th>
                </tr>
              </thead>
              <tbody>
                <% neunerStats.forEach((item) => { %>
                  <tr>
                    <td><%= item.first_name %> <%= item.last_name || '' %></td>
                    <td data-value="<%= item.total %>"><%= item.total %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <p class="subtle" style="text-align: center; padding: 2rem 0;">Noch keine Daten.</p>
        <% } %>
      </div>
      <div>
        <h2 style="margin-top: 0;">Kränze</h2>
        <% if (kraenzeStats.length > 0) { %>
          <div class="records-table-wrap">
            <table class="records-table sortable-table">
              <thead>
                <tr>
                  <th data-sort="string">Name</th>
                  <th data-sort="number">Gesamt</th>
                </tr>
              </thead>
              <tbody>
                <% kraenzeStats.forEach((item) => { %>
                  <tr>
                    <td><%= item.first_name %> <%= item.last_name || '' %></td>
                    <td data-value="<%= item.total %>"><%= item.total %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <p class="subtle" style="text-align: center; padding: 2rem 0;">Noch keine Daten.</p>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Tab: Allgemein -->
  <div class="tab-panel" id="tab-allgemein">
    <!-- Summary stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value"><%= totalGamedays %></div>
        <div class="stat-label">Spieltage</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><%= settledGamedays %></div>
        <div class="stat-label">Abgerechnet</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><%= formatEuro(totalPaid) %> €</div>
        <div class="stat-label">Zahlungen</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><%= totalPenalties %></div>
        <div class="stat-label">Strafen</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><%= memberCount %></div>
        <div class="stat-label">Mitglieder</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><%= guestCount %></div>
        <div class="stat-label">Gäste</div>
      </div>
    </div>

    <!-- Leaderboards -->
    <div class="split-grid">
      <% if (topAttendance.length > 0) { %>
        <div class="leaderboard">
          <div class="leaderboard-header">Meiste Teilnahmen</div>
          <% topAttendance.forEach((item, i) => { %>
            <div class="leaderboard-item">
              <span class="leaderboard-rank"><%= i + 1 %></span>
              <span class="leaderboard-name"><%= item.first_name %> <%= item.last_name || '' %></span>
              <span class="leaderboard-value"><%= item.games %> Spiele</span>
            </div>
          <% }) %>
        </div>
      <% } %>

      <% if (topPayers.length > 0) { %>
        <div class="leaderboard">
          <div class="leaderboard-header">Summe Zahlungen</div>
          <% topPayers.forEach((item, i) => { %>
            <div class="leaderboard-item">
              <span class="leaderboard-rank"><%= i + 1 %></span>
              <span class="leaderboard-name"><%= item.first_name %> <%= item.last_name || '' %></span>
              <span class="leaderboard-value"><%= formatEuro(item.total) %> €</span>
            </div>
          <% }) %>
        </div>
      <% } %>

      <% if (mostPudel.length > 0) { %>
        <div class="leaderboard">
          <div class="leaderboard-header">Meiste Pudel</div>
          <% mostPudel.forEach((item, i) => { %>
            <div class="leaderboard-item">
              <span class="leaderboard-rank"><%= i + 1 %></span>
              <span class="leaderboard-name"><%= item.first_name %> <%= item.last_name || '' %></span>
              <span class="leaderboard-value"><%= item.total %>×</span>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>

    <% if (monthlySummary.length > 0) { %>
      <h2 style="margin-top: 2rem;">Monatsübersicht <%= currentYear %></h2>
      <div class="records-table-wrap">
        <table class="records-table">
          <thead>
            <tr>
              <th>Monat</th>
              <th>Spieltage</th>
              <th>Beiträge</th>
              <th>Strafen</th>
            </tr>
          </thead>
          <tbody>
            <% monthlySummary.forEach((month) => { %>
              <tr>
                <td><%= month.monthName %></td>
                <td><%= month.gamedays %></td>
                <td><%= formatEuro(month.contributions) %> €</td>
                <td><%= month.penalties %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>

    <% if (recentGamedays.length > 0) { %>
      <h2 style="margin-top: 2rem;">Letzte Spieltage</h2>
      <div class="records-table-wrap">
        <table class="records-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Notiz</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% recentGamedays.forEach((day) => { %>
              <tr>
                <td><a href="/kegelkladde?gamedayId=<%= day.id %>"><%= day.match_date %></a></td>
                <td><%= day.note || '-' %></td>
                <%
                  const sLabels = ['Noch nicht begonnen', 'Spieltag läuft - gut Holz!', 'Abrechnung', 'Archiv'];
                  const sBadges = ['badge-muted', 'badge-warning', 'badge-info', 'badge-success'];
                %>
                <td>
                  <span class="badge <%= sBadges[day.settled] || 'badge-muted' %>"><%= sLabels[day.settled] || 'Unbekannt' %></span>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </div>
</section>
<%- include("partials/bottom") %>
